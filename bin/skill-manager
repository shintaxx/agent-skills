#!/bin/bash

# Get the absolute path of the directory where this script is located
BIN_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
REPO_ROOT="$(dirname "$BIN_DIR")"
SKILLS_DIR="$REPO_ROOT/skills"

# Check if skills directory exists
if [ ! -d "$SKILLS_DIR" ]; then
    echo "Error: Skills directory not found at $SKILLS_DIR"
    exit 1
fi

echo "Agent Skill Manager"
echo "==================="

# 1. Collect available skills and their names from SKILL.md
declare -a available_skills
declare -a skill_dirs
index=0

echo "Scanning for skills..."
for dir in "$SKILLS_DIR"/*/; do
    if [ -d "$dir" ]; then
        skill_dir_name=$(basename "$dir")
        skill_md="$dir/SKILL.md"

        if [ -f "$skill_md" ]; then
            # Extract name from YAML frontmatter using basic grep/awk
            # Assumes 'name: value' format
            skill_name=$(grep -m 1 "^name:" "$skill_md" | awk -F': ' '{print $2}' | tr -d '\r' | tr -d '"' | tr -d "'")
            
            if [ -n "$skill_name" ]; then
                available_skills[$index]="$skill_name"
            else
                available_skills[$index]="$skill_dir_name (Name not found in SKILL.md)"
            fi
            skill_dirs[$index]="$skill_dir_name"
            index=$((index+1))
        fi
    fi
done

if [ ${#available_skills[@]} -eq 0 ]; then
    echo "No valid skills found in $SKILLS_DIR"
    exit 1
fi

# 2. Interactive Skill Selection
echo ""
echo "Select a skill to install:"
for i in "${!available_skills[@]}"; do
    echo "$((i+1)). ${available_skills[$i]}"
done

read -p "Enter number (1-$index): " skill_choice
skill_index=$((skill_choice-1))

if [[ "$skill_index" -lt 0 || "$skill_index" -ge "$index" ]]; then
    echo "Invalid selection."
    exit 1
fi

selected_skill_name="${available_skills[$skill_index]}"
selected_skill_dir="${skill_dirs[$skill_index]}"
source_path="$SKILLS_DIR/$selected_skill_dir"

echo ""
echo "Selected Skill: $selected_skill_name"

# 3. Target Environment Selection
echo ""
echo "Select target environment:"
echo "1. Claude (.claude/skills/)"
echo "2. Antigravity/Gemini (.agent/skills/)"
echo "3. Codex (.github/skills/)"

read -p "Enter number (1-3): " target_choice

case $target_choice in
    1)
        target_base=".claude"
        target_sub="skills"
        ;;
    2)
        target_base=".agent"
        target_sub="skills"
        ;;
    3)
        target_base=".github"
        target_sub="skills"
        ;;
    *)
        echo "Invalid selection."
        exit 1
        ;;
esac

target_dir="$PWD/$target_base/$target_sub"
target_link="$target_dir/$selected_skill_dir"

# 4. Installation (Copy)
echo ""
echo "Installing to: $target_link"

# Create target directory if it doesn't exist
if [ ! -d "$target_dir" ]; then
    echo "Creating directory: $target_dir"
    mkdir -p "$target_dir"
fi

# Check if target already exists
if [ -e "$target_link" ]; then
    echo "Warning: Target already exists."
    read -p "Overwrite? (y/n): " overwrite
    if [[ "$overwrite" != "y" ]]; then
        echo "Aborted."
        exit 0
    fi
    rm -rf "$target_link"
fi

# Copy skill directory
cp -r "$source_path" "$target_link"

if [ $? -eq 0 ]; then
    echo "Success! Skill '$selected_skill_name' installed."
else
    echo "Error: Failed to copy skill."
    exit 1
fi
